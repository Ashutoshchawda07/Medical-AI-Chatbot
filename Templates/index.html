<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical AI Chatbot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #121212; }
        #chat-window { height: 70vh; overflow-y: auto; scroll-behavior: smooth; }
        .message { max-width: 80%; padding: 10px 15px; margin: 10px; border-radius: 20px; word-wrap: break-word; }
        .user-msg { background-color: #2e7d32; color: white; margin-left: auto; border-bottom-right-radius: 5px; }
        .bot-msg { background-color: #212121; color: #e0e0e0; margin-right: auto; border-bottom-left-radius: 5px; }
        .loading-dot {
            height: 8px; width: 8px; background-color: #e0e0e0; border-radius: 50%; display: inline-block; margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-8px); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div class="w-full max-w-2xl bg-gray-800 rounded-xl shadow-2xl p-6">
        <h1 class="text-3xl font-bold text-green-400 mb-4 border-b border-gray-700 pb-3">
            Medical AI Chatbot
        </h1>

        <!-- Chat Window -->
        <div id="chat-window" class="bg-gray-900 rounded-lg p-4 mb-4">
            <div class="bot-msg">Hello! I am your medical assistant. Ask me anything about health conditions.</div>
        </div>

        <!-- Input Form -->
        <form id="chat-form" class="flex space-x-3">
            <input type="text" id="user-input" placeholder="Type your medical query here..." 
                   class="flex-grow p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-150">
            <button type="submit" id="send-button"
                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-xl transition duration-150 shadow-md">
                Send
            </button>
        </form>
    </div>

    <script>
        const chatForm = document.getElementById('chat-form');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');

        // Function to create and append a message element
        function appendMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ' + (sender === 'user' ? 'user-msg' : 'bot-msg');
            msgDiv.textContent = text;
            chatWindow.appendChild(msgDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            return msgDiv;
        }

        // Function to show a typing indicator
        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator';
            indicator.className = 'bot-msg flex items-center space-x-2';
            indicator.innerHTML = `
                <span>Typing...</span>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
                <div class="loading-dot"></div>
            `;
            chatWindow.appendChild(indicator);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // Function to remove the typing indicator
        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        chatForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            const message = userInput.value.trim();

            if (message === '') return;

            // 1. Display user message and clear input
            appendMessage(message, 'user');
            userInput.value = '';

            // 2. Show typing indicator
            showTypingIndicator();

            try {
                // 3. Send message as JSON data to the /get endpoint
                const response = await fetch('/get', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json', // CRITICAL: Specify JSON content type
                    },
                    // CRITICAL: Send data as JSON string with the expected 'message' key
                    body: JSON.stringify({ message: message }) 
                });

                // 4. Check for success status and parse response
                if (!response.ok) {
                    const errorJson = await response.json().catch(() => ({ answer: 'Server returned error.' }));
                    throw new Error(`HTTP error ${response.status}: ${errorJson.answer || 'Unknown error'}`);
                }

                const data = await response.json();
                
                // 5. Remove indicator and display bot response
                removeTypingIndicator();
                appendMessage(data.answer || "I'm sorry, I couldn't process that response.", 'bot');

            } catch (error) {
                // 6. Handle API/network errors
                removeTypingIndicator();
                console.error('Fetch error:', error);
                appendMessage(`System Error: ${error.message}`, 'bot');
            }
        });
    </script>
</body>
</html>
